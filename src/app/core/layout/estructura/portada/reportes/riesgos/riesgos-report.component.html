<section class="report-page">
  <header class="report-header">
    <button
      mat-icon-button
      (click)="volverDashboard()"
      matTooltip="Volver al dashboard"
    >
      <mat-icon>arrow_back</mat-icon>
    </button>
    <div class="report-title">
      <h1>Reporte de riesgos abiertos</h1>
      <p>Detalle de riesgos altos con planes de mitigaci贸n</p>
    </div>
    <button mat-stroked-button color="primary" (click)="exportar()">
      <mat-icon>file_download</mat-icon>
      Exportar
    </button>
  </header>

  @if (error()) {
  <mat-card class="feedback error">
    <mat-icon>error</mat-icon>
    <span>{{ error() }}</span>
  </mat-card>
  } @if (cargando()) {
  <mat-card class="feedback loading">
    <mat-icon class="spinning">sync</mat-icon>
    <span>Cargando riesgos...</span>
  </mat-card>
  }

  <div class="summary-grid">
    <mat-card class="summary-card">
      <mat-icon>crisis_alert</mat-icon>
      <div>
        <span class="summary-value">{{ riesgosCriticos() }}</span>
        <span class="summary-label">Riesgos de impacto alto</span>
      </div>
    </mat-card>
    <mat-card class="summary-card">
      <mat-icon>pending_actions</mat-icon>
      <div>
        <span class="summary-value">{{ pendientes() }}</span>
        <span class="summary-label">Planes pendientes de activar</span>
      </div>
    </mat-card>
    <mat-card class="summary-card">
      <mat-icon>event_available</mat-icon>
      <div>
        <span class="summary-value">{{ proximosHitos().length }}</span>
        <span class="summary-label">Pr贸ximos hitos</span>
      </div>
    </mat-card>
  </div>

  <mat-card class="table-card">
    <div class="table-head">
      <h2>Detalle de riesgos</h2>
      <span>
        Actualizado
        {{
          proximosHitos().length
            ? "al " + formatearFecha(proximosHitos()[0])
            : "recientemente"
        }}
      </span>
    </div>
    <div class="table-wrapper">
      @if (!cargando() && !riesgos().length) {
      <div class="empty-state">
        <mat-icon>check_circle</mat-icon>
        <p>No se encontraron riesgos abiertos en el rango consultado.</p>
      </div>
      } @else {
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Riesgo</th>
            <th>Impacto</th>
            <th>Probabilidad</th>
            <th>Mitigaci贸n</th>
            <th>Pr贸ximo hito</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          @for (riesgo of riesgos(); track riesgo.id) {
          <tr>
            <td>{{ riesgo.id }}</td>
            <td>{{ riesgo.titulo }}</td>
            <td>
              <mat-chip [ngClass]="'nivel-' + riesgo.impacto.toLowerCase()">
                {{ riesgo.impacto }}
              </mat-chip>
            </td>
            <td>{{ riesgo.probabilidad }}</td>
            <td>{{ riesgo.mitigacion }}</td>
            <td>{{ formatearFecha(riesgo.proximoHito) }}</td>
            <td>
              <mat-chip
                [ngClass]="
                  'estado-' + riesgo.estado.replace(' ', '-').toLowerCase()
                "
              >
                {{ extraerSiglaEstado(riesgo.estado) }}
              </mat-chip>
            </td>
          </tr>
          }
        </tbody>
      </table>
      }
    </div>
  </mat-card>
</section>
